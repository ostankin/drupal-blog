version: '2'

services:
   db:
     image: mysql:5.7
     volumes:
       - "./.data/db:/var/lib/mysql"
       - "./.db_import:/docker-entrypoint-initdb.d"
     restart: always
     env_file:
       - "./.db-secret"

   certbot:
     image: salemove/letsencrypt-dns
     volumes:
       - "le-certs:/certs"
     restart: always
     environment:
       - PROVIDER=route53
       - CERTBOT_DOMAIN=*.ostankin.net
       - CERTBOT_ALIAS=myx.ostankin.net
     env_file:
       - "./.certbot-secret"

   nginx:
     depends_on:
       - drupal
       - s3-proxy
       - certbot
     image: nginx:stable
     volumes:
       - "le-certs:/certs"
       - "./nginx.conf.d:/etc/nginx/conf.d"
       - "./.data/files/kuradiauk:/usr/share/nginx/kuradiauk"
     ports:
       - "80:80"
       - "443:443"
     links:
       - drupal
       - s3-proxy
     restart: always

   s3-proxy:
     image: coopernurse/nginx-s3-proxy
     volumes:
       - "./s3-proxy.conf:/nginx.conf"
       - "./s3-proxy-common.conf:/s3-proxy-common.conf"
       - "./.s3-proxy-secret.conf:/s3-secret.conf"
     restart: always

   drupal:
     depends_on:
       - db
     image: drupal:7.51-apache
     volumes:
       - "./.data/cms/myx:/var/www/html"
     links:
       - db
     restart: always

   modx:
     depends_on:
       - db
     image: gerasim13/modx-docker
     volumes:
       - "./.data/cms/aqtest:/var/www/html"
     links:
       - db:mysql
     restart: always

volumes:
  le-certs:
